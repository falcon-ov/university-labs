# Лабораторная работа №2. Введение в AWS. Вычислительные сервисы

## Цель работы

Познакомиться с основными вычислительными сервисами AWS, научиться создавать и настраивать виртуальные машины (EC2), а также развёртывать простые веб-приложения.

## Условие

### Задание 0. Подготовка среды

1. Я зарегистрировался в AWS и создал бесплатный аккаунт (Free Tier).
   - Перешел по ссылке: [https://aws.amazon.com/](https://aws.amazon.com/)
   - Нажал "Create an AWS Account" и следовал инструкциям.
2. Вошел в консоль управления под root-пользователем.
    ![img](/images/img_1.png)
3. В правом верхнем углу выбрал регион EU (Frankfurt) `eu-central-1`.
    ![img](/images/img_2.png)

### Задание 1. Создание IAM группы и пользователя

_IAM_ — это сервис для управления доступом в AWS. Здесь создаются пользователи, группы и политики (наборы прав).

1. Открыл сервис IAM (Identity and Access Management).
![img](/images/img_3.png)

2. Создал IAM группу `Admins`:

   1. Перешел в раздел `"Groups"` и нажал `"Create New Group"`.
   2. Ввел имя группы `Admins` и нажал "Next Step".
   3. На шаге "Attach Policy" выбрал политику `AdministratorAccess`.
    ![img](/images/img_4.png)
    ![img](/images/img_5.png)

    > Что делает данная политика?

    > Ответ: Политика AdministratorAccess даёт полный доступ ко всем сервисам и ресурсам AWS — пользователь или группа с этой политикой могут управлять всем в аккаунте.

3. Создал IAM пользователя с любым именем:

   1. Перешел в раздел `"Users"` и нажал `"Add user"`.
   2. Ввел имя пользователя, например `cloudstudent`.
   3. Привязал пользователя к группе `Admins`.
   4. Разрешил пользователю доступ в AWS Management Console.
    ![img](/images/img_6.png)
    ![img](/images/img_7.png)
    ![img](/images/img_8.png)
    ![img](/images/img_9.png)

4. Убедился, что пользователь создан и имеет доступ к консоли.
![img](/images/img_10.png)
5. Вышел из консоли под root-пользователем и вошел под новым IAM пользователем.
![img](/images/img_11.png)
![img](/images/img_12.png)
![img](/images/img_13.png)


### Задание 2. Настройка Zero-Spend Budget

1. Открыл сервис Billing and Cost Management.
![img](/images/img_14.png)
2. В меню слева выбрал `Budgets` → `Create budget`.
![img](/images/img_15.png)
3. Выбрал "Zero spend budget" шаблон и указал следующие параметры:
   - Budget name: `ZeroSpend`
   - Email recipients: ваш email
![img](/images/img_16.png)
4. Нажал "Create budget" внизу страницы.
![img](/images/img_17.png)

После создания данного бюджета вы будете получать уведомления, если ваши расходы превысят $0.

### Задание 3. Создание и запуск EC2 экземпляра (виртуальной машины)

Для запуска и настройки виртуальной машины используется сервис Amazon EC2 (Elastic Compute Cloud).

1.  Открыл сервис EC2.
![img](/images/img_18.png)
2.  В меню слева выбрал `Instances` → `Launch instances`.
3.  Заполнил соответствующие параметры для запуска виртуальной машины:

    1.  _Name and tags_: `webserver`.
    2.  _AMI_: Выбрал Amazon Linux 2023 AMI. Это образ, который будет использоваться для создания виртуальной машины.
    3.  _Instance type_: t3.micro.
    ![img](/images/img_18_0.png)
    4.  _Key pair_. Это криптографическая пара ключей (приватный и публичный). Она нужна для безопасного входа на сервер по SSH.
        1. Выбрал "Create a new key pair".
        2. Ввел имя для ключа в формате `daniilsocolov-keypair`.
        3. Нажал "Create key pair" и скачал файл с приватным ключом (расширение `.pem`). Сохранил его в надежном месте.
        ![img](/images/img_19.png)
    5.  _Security group_. Это набор правил, которые определяют, какой трафик разрешен к вашему экземпляру.

        1. Выбрал "Create a new security group".
        2. Ввел имя группы `webserver-sg`.
        3. Добавил два правила для входящего трафика (_Inbound rules_).
           - Разрешил входящий HTTP трафик с любого IP-адреса.
           - Разрешил входящий SSH трафик только с вашего текущего IP-адреса.
        ![img](/images/img_20.png)
    6.  _Network settings_. Оставил настройки по умолчанию. AWS автоматически создаст виртуальную сеть (VPC) и подсеть (subnet).

    7.  _Configure Storage_. Оставил настройки по умолчанию.

    8.  Пролистал вниз до _Advanced details_ → _User Data_ и вставил следующий скрипт:

    ```bash
    #!/bin/bash
    dnf -y update
    dnf -y install htop
    dnf -y install nginx
    systemctl enable nginx
    systemctl start nginx
    ```
    ![img](/images/img_21.png)

    В зависимости от выбранного AMI, команды в скрипте могут отличаться.

    > Что такое _User Data_ и какую роль выполняет данный скрипт? Для чего используется nginx?

    > Ответ: User Data — это скрипт или команды, которые автоматически выполняются при первом запуске (инициализации) EC2-инстанса. Его используют, чтобы сразу установить нужные пакеты, настроить сервисы, развернуть приложения без ручного входа на сервер.

4.  Нажал `Launch instance` и дождался статуса _Running_ и _Status checks: 2/2_. После того, как виртуальная машина запустилась, я увидел её публичный IP-адрес в колонке "IPv4 Public IP".
![img](/images/img_22.png)
![img](/images/img_23.png)

```
Перед проверкой пришлось подключиться к instance и вручную установить nginx:

sudo dnf -y update
sudo dnf -y install htop
sudo dnf -y install nginx
sudo systemctl enable nginx
sudo systemctl start nginx 
```
5.  Проверил, что веб-сервер работает, открыв в браузере URL: `http://13.53.131.23 `, где `13.53.131.23 ` — это публичный IP-адрес моей виртуальной машины.
![img](/images/img_24.png)

### Задание 4. Логирование и мониторинг

_Мониторинг_ — это важная часть обеспечения надёжности, доступности и производительности ваших экземпляров Amazon EC2 и решений в AWS.

1. Открыл вкладку Status checks.

   - В карточке вашего инстанса EC2 нашел вкладку Status checks.
   - Здесь вы можете быстро определить, выявил ли Amazon EC2 какие-либо проблемы, которые могут помешать работе приложений.
   - Amazon EC2 выполняет автоматические проверки для каждого работающего экземпляра:
     - _System reachability check_ — проверяет инфраструктуру AWS (железо и гипервизор).
     - _Instance reachability check_ — проверяет, доступна ли операционная система на уровне инстанса.
   - Убедился, что обе проверки прошли успешно (2/2 checks passed).
      ![img](/images/img_25.png)

2. Открыл вкладку _Monitoring_.

   - На этой вкладке отображаются метрики Amazon CloudWatch для вашего инстанса.
   ![img](/images/img_26.png)
   - Так как инстанс был создан недавно, метрик пока немного.
   - Вы можете нажать на иконку с тремя точками на любом графике и выбрать _Enlarge_, чтобы открыть метрику в развёрнутом виде.
   - По умолчанию включён базовый мониторинг (Basic monitoring) — данные отправляются в CloudWatch каждые 5 минут.
   - При необходимости можно включить детализированный мониторинг (Detailed monitoring) — метрики будут отправляться каждую минуту.

   > В каких случаях важно включать детализированный мониторинг?

   > Ответ: Детализированный мониторинг стоит включать, когда нужно отслеживать состояние инстанса в реальном времени или реагировать на изменения быстрее, чем раз в 5 минут.

3. Просмотр системного лога (System Log)

   - В верхнем меню нажал `Actions` → `Monitor and troubleshoot` → `Get system log`.
   ![img](/images/img_27.png)
   - Здесь отображается вывод консоли инстанса. Это полезный инструмент для диагностики:
     - помогает разбирать ошибки ядра,
     - ошибки конфигурации сервисов,
     - проблемы, из-за которых инстанс может завершиться или стать недоступным до старта SSH.
   - Пролистал вывод и нашел строки, показывающие установку пакетов (например, _nginx_ из вашего User Data).
      > Из-за того, что я делал reboot, логов установки nginx нет
   - Если лог пока пуст — подождите пару минут и попробуйте снова.
   - Нажал Cancel, чтобы выйти.

4. Просмотр снимка экрана инстанса (Instance Screenshot)
   - В меню выбрал `Actions` → `Monitor and troubleshoot` → `Get instance screenshot`.
   ![img](/images/img_28.png)
   - Я увидел изображение консоли EC2 (как если бы к нему был подключён монитор).
      > Консоль не отображается, хотя если подключиться к ней через `connect` все работает. Отображается запуск.
   - Это особенно полезно, если вы не можете подключиться к инстансу по SSH: скриншот помогает понять, зависла ли ОС, есть ли kernel panic или другие ошибки.
   - Нажал Cancel, чтобы выйти.

### Задание 5. Подключение к EC2 инстансу по SSH

1. Открыл терминал на вашем компьютере.
2. Перешел в директорию, где сохранён файл приватного ключа `.pem`.

   ```bash
   cd /path/to/your/key
   ```

3. Установил права на ключ (для Linux/MacOS):

   ```bash
   chmod 400 yournickname-keypair.pem
   ```

4. Если используете PowerShell или CMD, убедитесь, что:

   - Файл ключа `.pem` находится в директории, доступной только вашему пользователю,ине имеет разрешений для других пользователей.

   - Настроить можно следующим образом:
     - Щёлкните правой кнопкой мыши на файле `.pem` и выберите "Свойства".
     - Перейдите на вкладку "Безопасность".
     - Убедитесь, что доступ есть только у вашей учётной записи Windows.
     - Удалите права у «Все» (Everyone) или других пользователей.

5. Подключился к инстансу по SSH:

   ```bash
   ssh -i daniilsocolov-keypair.pem ec2-user@13.53.131.23
   ```

   где,

   - `-i` — это параметр, указывающий на файл приватного ключа.
   - `yournickname-keypair.pem` — это имя вашего файла с приватным ключом.
   - `ec2-user` — это стандартное имя пользователя для Amazon Linux AMI.
   - `<Public-IP>` — это публичный IP-адрес инстанса EC2.

   ![img](/images/img_29.png)


6. После успешного подключения я увидел приглашение командной строки, например:

   ```bash
   [ec2-user@ip-xx-xx-xx-xx ~]$
   ```

7. Выполнил команду для проверки статуса веб-сервера Nginx:

   ```bash
   systemctl status nginx
   ```
   ![img](/images/img_30.png)

   > Почему в AWS нельзя использовать пароль для входа по SSH?
   
   > В AWS нельзя использовать пароль для входа по SSH, потому что это менее безопасно и менее удобно, чем использование SSH-ключей. Пароль можно подобрать с помощью атак типа brute-force, а SSH-ключ (длиной 2048–4096 бит) взломать практически невозможно. Кроме того, AWS не хранит приватные ключи — они создаются только при запуске и остаются у пользователя, что исключает риск утечки.

- Далее, в зависимости от моей специализации, нужно было выбрать одно из трёх заданий (6a, 6b или 6c). Для специализации _Frontend & Backend & Security_ подойдут задания 6a и 6b, для специализации _DevOps_ — рекомендуется задание 6c.

- Не выбрано: `Задание 6a. Развёртывание статического веб-сайта (_Для специализаций Frontend & Backend & Security_) `

 - Не выбрано: `Задание 6b. Развёртывание веб-сайта на PHP (_Для специализаций Frontend & Backend & Security_)`

### Задание 6c. Запуск PHP-приложения в Docker (_Для специализации DevOps_)

Docker позволяет запускать приложения в контейнерах — изолированных средах, которые включают всё необходимое для работы приложения (библиотеки, зависимости, сервер). В AWS вы можете использовать Docker на EC2, а также готовые образы из Docker Hub или AWS Marketplace.

1. Подключился к инстансу EC2 по SSH
2. Установил Docker.

   ```bash
   sudo dnf -y install docker
   sudo systemctl enable docker
   sudo systemctl start docker
   sudo usermod -aG docker ec2-user
   ```

   Проверил, что Docker работает:

   ```bash
   docker --version
   ```
   ![img](/images/img_31.png)

3. Вышел из сессии SSH и подключился снова, чтобы обновить группы пользователя.

4. Используя `docker compose`, развернул PHP-приложение (созданное в рамках лабораторной работы по основам веб-разработки). Для работы приложения необходимо поднять несколько контейнеров, каждый из которых отвечает за свою часть инфраструктуры:

   - `nginx` — веб-сервер, принимающий HTTP-запросы и перенаправляющий их в PHP-обработчик.
   - `php-fpm` — сервис для интерпретации и выполнения PHP-кода.
   - `mysql` — реляционная база данных для хранения информации приложения.
   - `adminer` — лёгкий веб-интерфейс для администрирования базы данных (альтернатива phpMyAdmin).

   1. Скачал официальный Docker Compose CLI плагин
   ```bash
   mkdir -p ~/.docker/cli-plugins

   curl -SL https://github.com/docker/compose/releases/download/v2.18.1/docker-compose-linux-x86_64 -o ~/.docker/cli-plugins/docker-compose

   chmod +x ~/.docker/cli-plugins/docker-compose
   ```
   2. Установил git
   ![img](/images/img_32.png)

   3. Изменил 5 лабораторную по основам веб разработки, чтобы использовать в данном проекте(изменил sqlite на mysql, добавил docker и nginx конфиг)

   4. Клонировал проект в инстанс
   ![img](/images/img_33.png)

   5. отключил глобальный nginx, чтобы не занимал порт 80
   
   6. Запустил контейнеры
   `docker compose up -d`
   ![img](/images/img_34.png)

   7. Запустил сайт, увидел, что не хватает pdo-mysql. Выполнил следующие команды:
   ```bash
   sudo dnf install -y mariadb-connector-c-devel
   docker compose exec php bash
   docker-php-ext-install pdo_mysql
   ```

   8. Вручную зашел в контейнер php
   ```bash
   docker compose exec php bash
   ```
   и инициализировал бд
   ![img](/images/img_35.png)


5. После запуска убедился, что:
   *во время установки приложения на сервер, пришлось перезапусить сервер, поэтому публичный Ip изменился на `http://16.171.32.127/`

   - Приложение доступно по адресу `http://<Public-IP>`.
   ![img](/images/img_36.png)

   - Приложение корректно взаимодействует с базой данных MySQL.
   
   - Чтобы админка открывалась, необходимо добавить в security group custom tcp с портом 8080
   ![img](/images/img_37.png)

   - Админка Adminer доступна по адресу `http://<Public-IP>:8080`.
   ![img](/images/img_38.png)

### Задание 7. Завершение работы и удаление ресурсов

   1. Остановил запущенную виртуальную машину (инстанс EC2) _используя AWS CLI_.

   - Добавил новую роль с full access
   - Добавил ее в инстанс
   - Выполнил команду в консоли для остановки инстанса
   ![img](/images/img_39.png)
   ![img](/images/img_40.png)
   ![img](/images/img_41.png)
   
2. Удалять виртуальную машину не обязательно, так как в следующей лабораторной работе вы будете работать с тем же инстансом.

> Чем «Stop» отличается от «Terminate»

> Stop — временно выключает инстанс, данные сохраняются, можно потом включить. Terminate — полностью удаляет инстанс, данные теряются, восстановить нельзя.

## Контрольные вопросы

Контрольные вопросы указаны выше в некоторых заданиях. Ответил на них письменно во время выполнения лабораторной работы.
