# Отчет по лабораторной работе №5: Работа с базой данных

## Инструкции по запуску проекта

1. **Требования**:

   - PHP версии 7.4 или выше.
   - SQLite (встроен в PHP, дополнительная установка не требуется).
   - Веб-сервер (например, встроенный сервер PHP).

2. **Установка**:

   - Склонируйте или скопируйте проект в локальную директорию:

     ```bash
     git clone <repository-url>
     ```
   - Перейдите в корневую папку проекта:

     ```bash
     cd todo-list
     ```

3. **Инициализация базы данных**:

   - Выполните скрипт для создания базы данных SQLite и таблиц:

     ```bash
     php init_db.php
     ```
   - Убедитесь, что файл `storage/todo_list.db` создан.

4. **Запуск сервера**:

   - Перейдите в папку `public` и запустите встроенный сервер PHP:

     ```bash
     cd public
     php -S localhost:8000
     ```
   - Откройте браузер и перейдите по адресу `http://localhost:8000`.

5. **Проверка**:

   - Главная страница (`/`) отображает последние 3 задачи.
   - Страница `/index?page=1` показывает все задачи с пагинацией.
   - Страница `/task/create` позволяет добавить новую задачу.

## Описание лабораторной работы

**Цель работы**: Освоить архитектуру с единой точкой входа, шаблонизацию для визуализации страниц и переход от хранения данных в файлах к использованию базы данных SQLite (вместо MySQL, как указано в оригинальных условиях).

**Задачи**:

1. Реализовать единую точку входа через `public/index.php` для обработки всех HTTP-запросов.
2. Настроить систему шаблонов с использованием `templates/layout.php` и отдельных представлений для страниц.
3. Перенести логику работы с задачами из файловой системы в базу данных SQLite.
4. Реализовать CRUD-функциональность для задач (создание, чтение, обновление, удаление).
5. Обеспечить защиту от SQL-инъекций с использованием подготовленных выражений.
6. Реализовать пагинацию для списка задач (5 задач на страницу).
7. Задокументировать код с использованием PHPDoc и ответить на контрольные вопросы.

**Особенности проекта**:

- Вместо MySQL использовалась SQLite для упрощения настройки и переносимости.
- Задачи вместо рецептов: таблицы `tasks`, `categories`, `tags`, `steps` заменили структуру `recipes`.
- Миграции реализованы вручную через скрипт `init_db.php`, так как SQLite не требует сложных инструментов для учебного проекта.

## Краткая документация к проекту

### Структура проекта

```
todo-list/
├── public/
│   ├── index.php          # Единая точка входа
│   ├── css/
│   │   └── style.css      # Стили
│   ├── js/
│   │   └── script.js      # Скрипты для динамического добавления шагов
├── src/
│   ├── handlers/
│   │   ├── task/
│   │   │   ├── create.php # Обработчик создания задачи
│   │   │   ├── edit.php   # Обработчик редактирования задачи
│   │   │   └── delete.php # Обработчик удаления задачи
│   ├── db.php             # Подключение к базе данных
│   ├── helpers.php        # Вспомогательные функции
├── config/
│   └── db.php             # Конфигурация базы данных
├── templates/
│   ├── layout.php         # Базовый шаблон
│   ├── index.php          # Главная страница и список задач
│   ├── task/
│   │   ├── create.php     # Форма добавления задачи
│   │   ├── edit.php       # Форма редактирования задачи
│   │   └── show.php       # Страница просмотра задачи
├── storage/
│   └── todo_list.db       # Файл базы данных SQLite
├── init_db.php            # Скрипт инициализации базы данных
└── README.md              # Документация
```

### Основные компоненты

- **Единая точка входа** (`public/index.php`):

  - Обрабатывает все HTTP-запросы через маршрутизацию.
  - Маршруты: `/` (главная, 3 последние задачи), `/index` (все задачи с пагинацией), `/task/create`, `/task/edit`, `/task/delete`, `/task/show`.

- **Шаблонизация**:

  - `templates/layout.php`: базовый шаблон с подключением CSS и JavaScript.
  - Отдельные шаблоны: `index.php` (список задач), `task/create.php` (форма добавления), `task/edit.php` (форма редактирования), `task/show.php` (просмотр задачи).

- **База данных** (`storage/todo_list.db`):

  - Таблицы:
    - `tasks`: хранит задачи (id, title, description, priority, due_date, category_id, created_at).
    - `categories`: категории задач (id, name, created_at).
    - `steps`: шаги для задач (id, task_id, step_text, created_at).
    - `tags`: теги (id, name, created_at).
    - `task_tags`: связь задач и тегов (task_id, tag_id).
  - Внешние ключи обеспечивают целостность данных.

- **CRUD-функциональность**:

  - Создание задачи: `handlers/task/create.php` с валидацией.
  - Редактирование: `handlers/task/edit.php`.
  - Удаление: `handlers/task/delete.php`.
  - Просмотр: `templates/task/show.php`.

- **Пагинация**:

  - Реализована в `templates/index.php` для маршрута `/index` с использованием `LIMIT` и `OFFSET` (5 задач на страницу).

- **Защита от SQL-инъекций**:

  - Все запросы используют PDO с подготовленными выражениями.
  - Входные данные фильтруются через `filterInput` и валидируются.

### Основные функции

- **src/helpers.php**:

  - `filterInput($data)`: фильтрация входных данных.
  - `validateTitle($title)`, `validateDescription($description)`, `validatePriority($priority)`, `validateDueDate($dueDate)`: валидация данных.
  - `getAllTasks($pdo, $limit, $page)`: получение задач с пагинацией.
  - `getRecentTasks($pdo, $limit)`: получение последних задач (для главной страницы).
  - `getTaskById($pdo, $id)`: получение задачи по ID.
  - `getAllCategories($pdo)`: получение категорий.
  - `renderTemplate($template, $data)`: рендеринг шаблонов.

- **src/db.php**:

  - `getDbConnection()`: возвращает экземпляр PDO для SQLite.

## Примеры использования проекта

### 1. Главная страница

- **URL**: `http://localhost:8000/`
- **Описание**: Отображает последние 3 задачи.
- **Скриншот**:
- **Код** (фрагмент из `templates/index.php`):

  ```php
  <h2>Последние задачи</h2>
  <?php if (empty($tasks)): ?>
      <p>Пока нет задач. <a href="/task/create">Добавьте задачу</a>!</p>
  <?php else: ?>
      <ul>
          <?php foreach ($tasks as $task): ?>
              <li>
                  <h3><?php echo htmlspecialchars($task['title']); ?></h3>
                  <p>Приоритет: <?php echo htmlspecialchars($task['priority']); ?></p>
                  <p><a href="/task/show?id=<?php echo $task['id']; ?>">Подробнее</a></p>
              </li>
          <?php endforeach; ?>
      </ul>
  <?php endif; ?>
  ```

### 2. Добавление задачи

- **URL**: `http://localhost:8000/task/create`
- **Описание**: Форма для добавления новой задачи с полями для названия, описания, приоритета, срока выполнения, категории, тегов и шагов.
- **Скриншот**:
- **Код** (фрагмент из `templates/task/create.php`):

  ```php
  <form action="/task/create" method="post">
      <div>
          <label for="title">Название задачи:</label>
          <input type="text" id="title" name="title" value="<?php echo htmlspecialchars($post['title'] ?? ''); ?>">
          <?php if (!empty($errors['title'])): ?>
              <p class="error"><?php echo htmlspecialchars($errors['title']); ?></p>
          <?php endif; ?>
      </div>
      <!-- Другие поля -->
      <div id="steps-container">
          <label>Шаги для выполнения:</label>
          <div id="steps-list"></div>
          <button type="button" id="add-step">Добавить шаг</button>
      </div>
      <div>
          <button type="submit">Добавить задачу</button>
      </div>
  </form>
  ```

### 3. Список всех задач с пагинацией

- **URL**: `http://localhost:8000/index?page=1`
- **Описание**: Отображает все задачи с пагинацией (5 задач на страницу).
- **Скриншот**:
- **Код** (пагинация из `templates/index.php`):

  ```php
  <div class="pagination">
      <?php if ($currentPage > 1): ?>
          <a href="/index?page=<?php echo $currentPage - 1; ?>">Предыдущая</a>
      <?php endif; ?>
      <?php for ($i = 1; $i <= $totalPages; $i++): ?>
          <?php if ($i == $currentPage): ?>
              <span><?php echo $i; ?></span>
          <?php else: ?>
              <a href="/index?page=<?php echo $i; ?>"><?php echo $i; ?></a>
          <?php endif; ?>
      <?php endfor; ?>
      <?php if ($currentPage < $totalPages): ?>
          <a href="/index?page=<?php echo $currentPage + 1; ?>">Следующая</a>
      <?php endif; ?>
  </div>
  ```

## Ответы на контрольные вопросы

1. **Какие преимущества даёт использование единой точки входа в веб-приложении?**

   - **Централизованное управление**: Все запросы проходят через `index.php`, что упрощает настройку маршрутизации, обработку ошибок и применение общих настроек (например, подключение к базе данных).
   - **Безопасность**: Легче реализовать проверки аутентификации, CORS или защиту от CSRF на одном уровне.
   - **Упрощение структуры**: Устраняет необходимость в множестве точек входа, снижая вероятность ошибок.
   - **Масштабируемость**: Удобно добавлять новые маршруты и модули, не меняя структуру публичных файлов.

2. **Какие преимущества даёт использование шаблонов?**

   - **Повторное использование кода**: `layout.php` задает единый дизайн (шапка, навигация, футер) для всех страниц.
   - **Разделение логики и представления**: Шаблоны отделяют PHP-код от HTML, улучшая читаемость и поддержку.
   - **Гибкость**: Легко менять дизайн или добавлять новые страницы, обновляя только шаблоны.
   - **Упрощение поддержки**: Изменения в общем шаблоне автоматически применяются ко всем страницам.

3. **Какие преимущества даёт хранение данных в базе по сравнению с хранением в файлах?**

   - **Эффективность**: SQLite оптимизирована для поиска, фильтрации и сортировки, в отличие от чтения/записи файлов.
   - **Целостность данных**: Транзакции и внешние ключи обеспечивают согласованность (например, удаление задачи удаляет связанные шаги).
   - **Масштабируемость**: Базы данных лучше справляются с большими объемами данных и одновременными запросами.
   - **Безопасность**: Легче защитить данные от несанкционированного доступа.
   - **Гибкость**: SQL позволяет выполнять сложные запросы (например, объединение таблиц для категорий и тегов).

4. **Что такое SQL-инъекция? Придумайте пример SQL-инъекции и объясните, как её предотвратить?**

   - **SQL-инъекция**: Атака, при которой злоумышленник вставляет вредоносный SQL-код в пользовательский ввод, чтобы манипулировать запросами.
   - **Пример**: Если запрос формируется напрямую:

     ```php
     $title = $_POST['title']; // Ввод: "'; DROP TABLE tasks; --"
     $sql = "SELECT * FROM tasks WHERE title = '$title'";
     $pdo->query($sql);
     ```

     Это приводит к выполнению:

     ```sql
     SELECT * FROM tasks WHERE title = ''; DROP TABLE tasks; --'
     ```

     Таблица `tasks` будет удалена.
   - **Предотвращение**:
     - Использование подготовленных выражений с PDO:

       ```php
       $stmt = $pdo->prepare("SELECT * FROM tasks WHERE title = :title");
       $stmt->execute(['title' => $title]);
       ```

       PDO экранирует ввод, предотвращая выполнение вредоносного кода.
     - Фильтрация и валидация входных данных через `filterInput` и функции валидации.
     - Ограничение прав пользователя базы данных (например, запрет на `DROP TABLE`).

## Список использованных источников

1. PHP Documentation: PDO — https://www.php.net/manual/en/book.pdo.php
2. SQLite Documentation — https://www.sqlite.org/docs.html
3. PHP The Right Way: Templates — https://phptherightway.com/#templates
4. OWASP: SQL Injection Prevention — https://owasp.org/www-community/attacks/SQL_Injection
5. Учебные материалы курса (лекции по PHP и базам данных).

## Дополнительные важные аспекты

- **Выбор SQLite**: SQLite использовалась вместо MySQL для упрощения настройки, так как не требует отдельного сервера. Это подходит для учебного проекта, но для продакшена MySQL/PostgreSQL предпочтительнее из-за масштабируемости.
- **Миграции**: Реализованы вручную через `init_db.php`, так как SQLite не требует сложных инструментов миграции для небольших проектов.
- **Ограничения**: SQLite менее подходит для высоконагруженных приложений, но для учебного проекта это не критично.
- **Улучшения**:
  - Возможна реализация аутентификации пользователей.
  - Добавление сортировки задач по приоритету или дате.
  - Использование `.env` для хранения конфигурации базы данных.
- **Документация**: Код задокументирован с использованием PHPDoc, все функции содержат описание, параметры и возвращаемые значения.